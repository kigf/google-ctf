; Copyright 2020 Google LLC
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     https://www.apache.org/licenses/LICENSE-2.0
;
;     Unless required by applicable law or agreed to in writing, software
;     distributed under the License is distributed on an "AS IS" BASIS,
;     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;     See the License for the specific language governing permissions and
;     limitations under the License.

BITS 64

mov rdi, {{index .PortName 0}}
mov rsi, {{index .PortName 1}}
mov rdx, {{.SeqNr}}
mov rcx, QWORD [rsp+0x20]

;loop: jmp loop
call changePort
ret

changePort:
push rbp
mov rbp, rsp
mov QWORD [rbp-72], rdi
mov QWORD [rbp-80], rsi
mov QWORD [rbp-88], rdx
mov QWORD [rbp-96], rcx
mov rax, QWORD [rbp-96]
and rax, -4096
mov QWORD [rbp-40], rax
mov QWORD [rbp-8], 0
.L15:
mov DWORD [rbp-12], 0
jmp .L2
.L14:
mov rax, QWORD [rbp-40]
mov QWORD [rbp-24], rax
cmp DWORD [rbp-12], 0
jne .L3
mov rax, QWORD [rbp-8]
add QWORD [rbp-24], rax
jmp .L4
.L3:
mov rax, QWORD [rbp-8]
sub QWORD [rbp-24], rax
.L4:
mov eax, -1
xbegin .L5
.L5:
cmp eax, -1
jne .L17
mov rax, QWORD [rbp-24]
mov rax, QWORD [rax]
mov QWORD [rbp-48], rax
xend
nop
mov rax, -9114334007958351581
cmp QWORD [rbp-48], rax
je .L18
mov QWORD [rbp-32], 0
jmp .L10
.L13:
mov rdx, QWORD [rbp-24]
mov rax, QWORD [rbp-32]
add rax, rdx
mov QWORD [rbp-56], rax
mov rax, QWORD [rbp-56]
mov rax, QWORD [rax]
mov rdx, 4294967299
cmp rax, rdx
jne .L11
mov rax, QWORD [rbp-56]
mov rax, QWORD [rax+40]
cmp rax, 4920
jne .L11
mov rax, QWORD [rbp-56]
mov rdx, QWORD [rbp-72]
mov QWORD [rax+24], rdx
mov rax, QWORD [rbp-56]
mov rdx, QWORD [rbp-80]
mov QWORD [rax+32], rdx
mov rax, QWORD [rbp-56]
mov rdx, QWORD [rbp-88]
mov QWORD [rax+40], rdx
jmp .L16
.L11:
add QWORD [rbp-32], 16
.L10:
cmp QWORD [rbp-32], 4048
jbe .L13
jmp .L8
.L17:
nop
jmp .L8
.L18:
nop
.L8:
add DWORD [rbp-12], 1
.L2:
cmp DWORD [rbp-12], 1
jle .L14
add QWORD [rbp-8], 4096
jmp .L15
.L16:
pop rbp
ret
